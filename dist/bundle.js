!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=4)}([function(e,t){e.exports=require("express")},function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(o(13)),s=n(o(3)),u=o(14).verbose(),i=n(o(2)),c=r.default.join(process.cwd(),i.default.get("db.path"));let a;s.default.existsSync(c)?a=u.cached.Database(c):(s.default.mkdirSync(r.default.dirname(c),{recursive:!0}),a=new u.Database(c,e=>{if(e)throw new Error("Failed to create a database connection");console.log("Connected to the words count database."),a.run("CREATE TABLE IF NOT EXISTS words_statistics (\n            word VARCHAR(50) PRIMARY KEY,\n            counter INTEGER DEFAULT 0 NOT NULL\n        ) WITHOUT ROWID;")})),a=u.cached.Database(c),t.default=a},function(e,t){e.exports=require("config")},function(e,t){e.exports=require("fs")},function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(o(2)),s=n(o(0)),u=n(o(5)),i=n(o(6)),c=n(o(7)),a=n(o(8)),l=n(o(15)),d=o(19),f=n(o(1)),p=s.default(),_=parseInt(process.env.PORT,10)||r.default.get("server.port");p.use(i.default()),p.use(u.default()),p.use(c.default.text({limit:"50gb"})),p.use("/word-counter",a.default),p.use("/word-statistics",l.default),p.use(d.errorHandler);const v=p.listen(_,e=>e?console.error(e):console.log(`server is listening on ${_}`));process.on("SIGTERM",()=>{console.info("SIGTERM signal received."),console.log("Closing http server."),v.close(()=>{console.log("Http server closed."),f.default.close(e=>{e&&console.error(e.message),console.log("SQLite connection closed."),process.exit(0)})})})},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("body-parser")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(9),s=n.Router();s.post("/",r.postWordCount),t.default=s},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,s){function u(e){try{c(n.next(e))}catch(e){s(e)}}function i(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(u,i)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=o(10);t.postWordCount=(e,t,o)=>n(void 0,void 0,void 0,(function*(){const n=e.get("Content-Type");e.is("text/plain")?(r.countWordsInText(e.body),t.sendStatus(200)):e.is("application/json")&&(e.body.filepath||e.body.url)?(console.log(">>>>>>> Request content type: ",n),yield r.countWordsInTextFile(e.body)):(t.status(400),o(new Error("An unsupported Content-Type was provided")))}))},function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(o(3)),s=o(11),u=o(12);t.countWordsInText=e=>{const t=s.cleanUpText(e).split(";").reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{});return u.insertWordStatistics(t)},t.countWordsInTextFile=e=>{const t=r.default.createReadStream(e);return new Promise((e,o)=>{t.on("data",e=>{console.log(e)}),t.on("error",o),t.on("end",()=>{e()})})}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cleanUpText=e=>(e=(e=e.replace(/[&\/\\#,+()!$~%.'":*?<>{}]/g,"")).replace(/\s+/g,";"),console.log(e.toLowerCase()),e.toLowerCase())},function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(o(1));t.insertWordStatistics=e=>{const t=r.default.prepare("INSERT INTO words_statistics (word, counter) VALUES(:word, :counter)\n        ON CONFLICT(word)\n        DO UPDATE SET counter = counter + :counter;\n    ");Object.entries(e).forEach(e=>{t.run(e,(function(e){e&&console.error("An error ocurred during insertion. Details: ",e)}))}),t.finalize()}},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("sqlite3")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(16),s=n.Router();s.get("/",r.getWordStatistics),t.default=s},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,s){function u(e){try{c(n.next(e))}catch(e){s(e)}}function i(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(u,i)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=o(17);t.getWordStatistics=(e,t,o)=>n(void 0,void 0,void 0,(function*(){const{word:o}=e.query;if(o)try{const e=yield r.queryWordCount(o);t.status(200).send(e.toString())}catch(e){console.error(e),t.sendStatus(500)}else t.sendStatus(400)}))},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(18);t.queryWordCount=e=>n.selectWordCount(e)},function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(o(1));t.selectWordCount=e=>new Promise((t,o)=>{r.default.get("SELECT counter FROM words_statistics WHERE word = (?)",[e],(e,n)=>{var r;e?o(e):t(null!==(r=null==n?void 0:n.counter)&&void 0!==r?r:0)})})},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.errorHandler=(e,t,o,n)=>{o.status(500).json({message:e.message})}}]);